import os 
import streamlit as st 
from dotenv import load_dotenv

from langchain_openai import ChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_chroma import Chroma
from langchain_openai import OpenAIEmbeddings
import json
from langchain.schema import Document

load_dotenv()

embedding_model = OpenAIEmbeddings(model="text-embedding-3-large")
vector_store = Chroma(embedding_function=embedding_model, collection_name = "products", persist_directory="./chroma_langchain_db_price")

retriever = vector_store.as_retriever(search_type = "mmr")

llm = ChatOpenAI(model_name = "gpt-4o-mini")

template = """
–¢—ã ‚Äì —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–¥–±–æ—Ä—É –∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É —Å–ø–µ—Ü–æ–¥–µ–∂–¥—ã.  
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∏–º –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Ç–æ–≤–∞—Ä—ã –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ—à–∏–≤–∞.  

### üîπ –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{question}

### üîπ –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
{retrieved_products}
---
### –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
 **–û—Ü–µ–Ω–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤**  
   - –ï—Å–ª–∏ –≤ –±–∞–∑–µ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—É, **–ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö —Å —Ä–∞–∑–º–µ—Ä–∞–º–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º**.  
   - –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç, **—É–∫–∞–∂–∏, —Å–∫–æ–ª—å–∫–æ –∏ –∫–∞–∫–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –Ω—É–∂–Ω–æ –ø–æ—à–∏—Ç—å**.  

 **–ï—Å–ª–∏ –∞–Ω–∞–ª–æ–≥–æ–≤ –Ω–µ—Ç ‚Äì –æ—Ü–µ–Ω–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—à–∏–≤–∞**  
   - –ú—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º **—Å–ø–µ—Ü–æ–¥–µ–∂–¥—É**. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–∞—à—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é, **–æ—Ü–µ–Ω–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—à–∏–≤–∞**.  
   - –ï—Å–ª–∏ –ø–æ—à–∏–≤ –≤–æ–∑–º–æ–∂–µ–Ω, **—É–∫–∞–∂–∏, —á—Ç–æ –º—ã –º–æ–∂–µ–º –ø–æ—à–∏—Ç—å –Ω—É–∂–Ω—ã–π –≤–∞–º —Ç–æ–≤–∞—Ä**.  
   - –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Å–ø–µ—Ü–æ–¥–µ–∂–¥–µ, –Ω–∞–ø–∏—à–∏, —á—Ç–æ –º—ã –Ω–µ –º–æ–∂–µ–º –µ–≥–æ –∏–∑–≥–æ—Ç–æ–≤–∏—Ç—å.  
---
### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
 **–ï—Å–ª–∏ –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥–∏ –≤ –Ω–∞–ª–∏—á–∏–∏:**  
 –ú—ã –º–æ–∂–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∞–Ω–∞–ª–æ–≥–∏:

–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∞ 1: —Ä–∞–∑–º–µ—Ä—ã, –≤ –Ω–∞–ª–∏—á–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–∞ 2: —Ä–∞–∑–º–µ—Ä—ã, –≤ –Ω–∞–ª–∏—á–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
 
**–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç(—á–∏—Å–ª–æ –≤ –Ω–∞–ª–∏—á–∏–∏ < —á–∏—Å–ª–∞ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ):**
–†–∞–∑–º–µ—Ä X: —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤ –Ω–∞–ª–∏—á–∏–∏ —Å–∫–æ–ª—å–∫–æ –µ—Å—Ç—å ‚Üí –ù—É–∂–Ω–æ –ø–æ—à–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
–†–∞–∑–º–µ—Ä Y: —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –Ω–æ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ ‚Üí –ù—É–∂–Ω–æ –ø–æ—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ

**–ï—Å–ª–∏ –∞–Ω–∞–ª–æ–≥–æ–≤ –Ω–µ—Ç, –Ω–æ –º–æ–∂–µ–º –ø–æ—à–∏—Ç—å:**  
–í –±–∞–∑–µ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∞–Ω–∞–ª–æ–≥–æ–≤, –Ω–æ –º—ã –º–æ–∂–µ–º —Å—à–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä.

**–ï—Å–ª–∏ –∞–Ω–∞–ª–æ–≥–æ–≤ –Ω–µ—Ç –∏ –ø–æ—à–∏–≤ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω:** 
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –Ω–∞—à–µ–π –±–∞–∑–µ –Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–æ–≤, –∏ –º—ã –Ω–µ –º–æ–∂–µ–º –∏–∑–≥–æ—Ç–æ–≤–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä,
—Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–ø–µ—Ü–æ–¥–µ–∂–¥—ã.

"""

prompt = PromptTemplate(input_variables=["retrieved_products", "question"], template=template)

llm_chain = prompt | llm | StrOutputParser()

rag_chain = {"retrieved_products":retriever , "question": RunnablePassthrough()} | llm_chain

st.title("–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞—è–≤–æ–∫")
input_text = st.text_area(label = "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", height=200)


if input_text:
    st.write(rag_chain.invoke(input_text))